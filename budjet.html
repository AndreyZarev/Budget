<!DOCTYPE html>
<html lang="bg">

<head>
    <meta charset="UTF-8" />
    <title>–ë—é–¥–∂–µ—Ç, –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –û—Ü–µ–Ω–∫–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
        }

        table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            border: 1px solid #ccc;
        }

        th {
            background: #f0f0f0;
        }

        input[type="number"] {
            width: 100px;
        }

        .center {
            text-align: center;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        .buttons {
            margin-bottom: 10px;
        }

        .buttons button {
            margin-right: 10px;
        }

        .summary-table {
            width: 100%;
            margin: 20px 0;
            border: 2px solid #99c;
        }

        .summary-table th,
        .summary-table td {
            padding: 10px;
            border: 1px solid #ccc;
        }

        .summary-table th {
            background: #eef;
        }
    </style>
</head>

<body>
    <h1 class="center">üìä –õ–∏—á–µ–Ω –ë—é–¥–∂–µ—Ç, –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –û—Ü–µ–Ω–∫–∞</h1>

    <!-- Tables for inputs -->
    <table>
        <thead>
            <tr>
                <th colspan="2">–î–æ—Ö–æ–¥</th>
            </tr>
        </thead>
        <tbody id="income">
            <tr>
                <td>–ó–∞–ø–ª–∞—Ç–∞</td>
                <td><input type="number" data-group="–¥–æ—Ö–æ–¥"></td>
            </tr>
            <tr>
                <td>–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–µ–Ω –¥–æ—Ö–æ–¥</td>
                <td><input type="number" data-group="–¥–æ—Ö–æ–¥"></td>
            </tr>
            <tr>
                <td>–ü–∞—Å–∏–≤–µ–Ω –¥–æ—Ö–æ–¥</td>
                <td><input type="number" data-group="–¥–æ—Ö–æ–¥"></td>
            </tr>
        </tbody>
    </table>

    <table>
        <thead>
            <tr>
                <th colspan="2">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</th>
            </tr>
        </thead>
        <tbody id="investment">
            <tr>
                <td>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—É—Ç–∞</td>
                <td><input type="number" data-group="–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"></td>
            </tr>
            <tr>
                <td>–ó–ª–∞—Ç–æ/–°—Ä–µ–±—Ä–æ</td>
                <td><input type="number" data-group="–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"></td>
            </tr>
            <tr>
                <td>–ó–µ–º—è/–ò–º–æ—Ç–∏</td>
                <td><input type="number" data-group="–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"></td>
            </tr>
            <tr>
                <td>–†–µ–∑–µ—Ä–≤–Ω–∞ –≤–∞–ª—É—Ç–∞</td>
                <td><input type="number" data-group="–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"></td>
            </tr>
        </tbody>
    </table>

    <table>
        <thead>
            <tr>
                <th colspan="2">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</th>
            </tr>
        </thead>
        <tbody id="prep">
            <tr>
                <td>–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –∑–∞–ø–∞—Å–∏</td>
                <td><input type="number" data-group="–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞"></td>
            </tr>
            <tr>
                <td>–í–æ–¥–∞/–§–∏–ª—Ç—ä—Ä–∏</td>
                <td><input type="number" data-group="–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞"></td>
            </tr>
            <tr>
                <td>–û—Ä—ä–∂–∏–µ/–°–∞–º–æ–∑–∞—â–∏—Ç–∞</td>
                <td><input type="number" data-group="–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞"></td>
            </tr>
            <tr>
                <td>–û–±—É—á–µ–Ω–∏–µ/–ó–Ω–∞–Ω–∏—è</td>
                <td><input type="number" data-group="–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞"></td>
            </tr>
            <tr>
                <td>–ê—Ä—Ç–∏–∫—É–ª–∏ –∑–∞ –æ—Ü–µ–ª—è–≤–∞–Ω–µ</td>
                <td><input type="number" data-group="–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞"></td>
            </tr>
        </tbody>
    </table>

    <table>
        <thead>
            <tr>
                <th colspan="2">–†–∞–∑—Ö–æ–¥–∏</th>
            </tr>
        </thead>
        <tbody id="expense">
            <tr>
                <td>–ù–∞–µ–º/–ö—Ä–µ–¥–∏—Ç</td>
                <td><input type="number" data-group="—Ä–∞–∑—Ö–æ–¥–∏"></td>
            </tr>
            <tr>
                <td>–°–º–µ—Ç–∫–∏</td>
                <td><input type="number" data-group="—Ä–∞–∑—Ö–æ–¥–∏"></td>
            </tr>
            <tr>
                <td>–•—Ä–∞–Ω–∞/–†–∞–∑—Ö–æ–¥–∏ –∑–∞ –¥–æ–º–∞</td>
                <td><input type="number" data-group="—Ä–∞–∑—Ö–æ–¥–∏"></td>
            </tr>
            <tr>
                <td>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/–ì–æ—Ä–∏–≤–æ</td>
                <td><input type="number" data-group="—Ä–∞–∑—Ö–æ–¥–∏"></td>
            </tr>
            <tr>
                <td>–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</td>
                <td><input type="number" data-group="—Ä–∞–∑—Ö–æ–¥–∏"></td>
            </tr>
        </tbody>
    </table>

    <div class="buttons">
        <button onclick="saveMonth()">üì¶ –ó–∞–ø–∞–∑–∏ –º–µ—Å–µ—Ü</button>
        <button onclick="removeLastMonth()">üóëÔ∏è –ò–∑—Ç—Ä–∏–π –ø–æ—Å–ª–µ–¥–Ω–∏—è –º–µ—Å–µ—Ü</button>
        <button onclick="clearData()">üß∏ –ò–∑—Ç—Ä–∏–π –≤—Å–∏—á–∫–æ</button>
    </div>

    <table class="summary-table" id="summaryTable"></table>

    <h3>üìà –ì–æ–¥–∏—à–µ–Ω –≥—Ä–∞—Ñ–∏–∫:</h3>
    <canvas id="yearChart" height="100"></canvas>

    <script>
        const secretKey = 'bgt2025';
        const storageKey = 'budgetData';

        function encryptData(data) {
            return CryptoJS.AES.encrypt(data, secretKey).toString();
        }

        function decryptData(cipherText) {
            try {
                const bytes = CryptoJS.AES.decrypt(cipherText, secretKey);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch {
                return "{}";
            }
        }

        let budgetData = {};
        try {
            const raw = localStorage.getItem(storageKey);
            if (raw) {
                const decrypted = decryptData(raw);
                budgetData = JSON.parse(decrypted);
            }
        } catch (e) {
            localStorage.removeItem(storageKey);
        }

        function sumInputs(group) {
            return Array.from(document.querySelectorAll(`input[data-group="${group}"]`))
                .map(input => parseFloat(input.value) || 0)
                .reduce((a, b) => a + b, 0);
        }

        function saveMonth() {
            const now = new Date();
            const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            const data = {
                –¥–æ—Ö–æ–¥: sumInputs("–¥–æ—Ö–æ–¥"),
                –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: sumInputs("–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"),
                –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞: sumInputs("–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞"),
                —Ä–∞–∑—Ö–æ–¥–∏: sumInputs("—Ä–∞–∑—Ö–æ–¥–∏"),
            };
            data.–æ—Å—Ç–∞—Ç—ä–∫ = data.–¥–æ—Ö–æ–¥ - data.–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ - data.–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ - data.—Ä–∞–∑—Ö–æ–¥–∏;

            if (!budgetData[month]) budgetData[month] = [];
            budgetData[month].push(data);

            localStorage.setItem(storageKey, encryptData(JSON.stringify(budgetData)));
            updateSummary();
            updateChart();
        }

        function removeLastMonth() {
            const now = new Date();
            const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            if (budgetData[month] && budgetData[month].length > 0) {
                budgetData[month].pop();
                if (budgetData[month].length === 0) delete budgetData[month];
                localStorage.setItem(storageKey, encryptData(JSON.stringify(budgetData)));
                updateSummary();
                updateChart();
            }
        }

        function clearData() {
            if (confirm("–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏?")) {
                budgetData = {};
                localStorage.removeItem(storageKey);
                updateSummary();
                updateChart();
            }
        }

        function updateSummary() {
            const table = document.getElementById("summaryTable");
            table.innerHTML = `<tr><th>–ú–µ—Å–µ—Ü</th><th>–î–æ—Ö–æ–¥</th><th>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</th><th>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</th><th>–†–∞–∑—Ö–æ–¥–∏</th><th>–û—Å—Ç–∞—Ç—ä–∫</th></tr>`;

            Object.entries(budgetData).forEach(([month, records]) => {
                const totals = records.reduce((acc, r) => {
                    acc.–¥–æ—Ö–æ–¥ += r.–¥–æ—Ö–æ–¥;
                    acc.–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ += r.–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏;
                    acc.–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ += r.–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞;
                    acc.—Ä–∞–∑—Ö–æ–¥–∏ += r.—Ä–∞–∑—Ö–æ–¥–∏;
                    acc.–æ—Å—Ç–∞—Ç—ä–∫ += r.–æ—Å—Ç–∞—Ç—ä–∫;
                    return acc;
                }, { –¥–æ—Ö–æ–¥: 0, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: 0, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞: 0, —Ä–∞–∑—Ö–æ–¥–∏: 0, –æ—Å—Ç–∞—Ç—ä–∫: 0 });

                table.innerHTML += `<tr>
                    <td>${month}</td>
                    <td>${totals.–¥–æ—Ö–æ–¥.toFixed(2)} –ª–≤</td>
                    <td>${totals.–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏.toFixed(2)} –ª–≤</td>
                    <td>${totals.–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞.toFixed(2)} –ª–≤</td>
                    <td>${totals.—Ä–∞–∑—Ö–æ–¥–∏.toFixed(2)} –ª–≤</td>
                    <td>${totals.–æ—Å—Ç–∞—Ç—ä–∫.toFixed(2)} –ª–≤</td>
                </tr>`;
            });
        }

        let chart;
        function updateChart() {
            const labels = Object.keys(budgetData);
            const datasets = {
                –¥–æ—Ö–æ–¥: [], –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: [], –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞: [], —Ä–∞–∑—Ö–æ–¥–∏: [], –æ—Å—Ç–∞—Ç—ä–∫: []
            };

            labels.forEach(month => {
                const entries = budgetData[month];
                const sum = entries.reduce((a, r) => {
                    a.–¥–æ—Ö–æ–¥ += r.–¥–æ—Ö–æ–¥;
                    a.–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ += r.–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏;
                    a.–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ += r.–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞;
                    a.—Ä–∞–∑—Ö–æ–¥–∏ += r.—Ä–∞–∑—Ö–æ–¥–∏;
                    a.–æ—Å—Ç–∞—Ç—ä–∫ += r.–æ—Å—Ç–∞—Ç—ä–∫;
                    return a;
                }, { –¥–æ—Ö–æ–¥: 0, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: 0, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞: 0, —Ä–∞–∑—Ö–æ–¥–∏: 0, –æ—Å—Ç–∞—Ç—ä–∫: 0 });

                Object.keys(sum).forEach(key => datasets[key].push(sum[key]));
            });

            if (chart) chart.destroy();
            const ctx = document.getElementById("yearChart").getContext("2d");
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: "–î–æ—Ö–æ–¥", data: datasets.–¥–æ—Ö–æ–¥, backgroundColor: '#4caf50' },
                        { label: "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", data: datasets.–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, backgroundColor: '#2196f3' },
                        { label: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞", data: datasets.–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, backgroundColor: '#ff9800' },
                        { label: "–†–∞–∑—Ö–æ–¥–∏", data: datasets.—Ä–∞–∑—Ö–æ–¥–∏, backgroundColor: '#f44336' },
                        { label: "–û—Å—Ç–∞—Ç—ä–∫", data: datasets.–æ—Å—Ç–∞—Ç—ä–∫, backgroundColor: '#9c27b0' },
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        window.onload = function () {
            updateSummary();
            updateChart();
        }
    </script>
</body>

</html>